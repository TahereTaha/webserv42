<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Server Class Behaviour</title>
</head>
<body>
	<h1>Server Class Behaviour</h1>

	<h2>Overview</h2>
	<p>
		The <code>Server</code> class is a HTTP server (one <code>t_server</code> configuration).
		It takes a parsed <code>Request</code> and returns a <code>ServerResponse</code>.
		It handles method validation, body size limits, route selection, filesystem mapping, simple
		uploads and deletes, and error pages.
	</p>

	<h2>Step-by-step Behaviour</h2>
	<ol>
		<li>
			<strong>Extract request data</strong><br />
			Reads the HTTP method and request target from the request's <code>ControlData</code>.
		</li>
		<li>
			<strong>Validate method</strong><br />
			If the method is not <code>GET</code>, <code>POST</code>, or <code>DELETE</code>,
			it returns a <code>405 Method Not Allowed</code> error response.
		</li>
		<li>
			<strong>Check POST body size</strong><br />
			If the method is <code>POST</code> and the body size exceeds
			<code>client_max_body_size</code> from the configuration, it returns
			<code>413 Payload Too Large</code>.
		</li>
		<li>
			<strong>Find the best matching route</strong><br />
			It iterates over the configured routes and selects the one whose <code>uri</code>
			is the longest prefix of the request target. If no route matches, it returns
			<code>404 Not Found</code>.
		</li>
		<li>
			<strong>Per-route method allowance (DEFAULT routes)</strong><br />
			For routes with <code>response_type == DEFAULT</code>, it checks if the
			method is contained in <code>route.default_response.accepted_methods</code>.
			If not, it returns <code>405 Method Not Allowed</code>.
		</li>
		<li>
			<strong>Dispatch based on route type</strong>
			<ul>
				<li>
					<strong>STATIC routes</strong><br />
					Builds a fixed HTML response using <code>route.static_response.status_code</code>
					and <code>route.static_response.text</code>. It does not access the filesystem.
				</li>
				<li>
					<strong>DEFAULT routes</strong><br />
					Maps the URI to the filesystem by stripping the route prefix and joining with
					<code>route.default_response.root</code>.
					<ul>
						<li>
							If the result is a directory and an <code>index_file</code> is set, it
								serves that index file.
						</li>
						<li>
							If it is a directory without an index and <code>directory_listing_enabled</code>
								is true, it generates a simple autoindex page listing directory entries.
						</li>
						<li>
							If directory listing is disabled and there is no index, it returns
								<code>403 Forbidden</code>.
						</li>
						<li>
							If the path is a file, it behaves per HTTP method:
								<ul>
									<li><strong>GET</strong>: reads the file, sets <code>Content-Type</code>
										based on the extension, and returns <code>200 OK</code> or <code>404</code>
										if the file cannot be read.</li>
									<li><strong>POST</strong>: writes the request body to the file
										(creating or overwriting) and returns <code>201 Created</code> on success
										or <code>500 Internal Server Error</code> on failure.</li>
									<li><strong>DELETE</strong>: deletes the file using <code>unlink</code> and
										returns <code>200 OK</code> on success, <code>404 Not Found</code> if the file
										does not exist, or <code>500 Internal Server Error</code> on other errors.</li>
								</ul>
						</li>
					</ul>
				</li>
			</ul>
		</li>
		<li>
			<strong>Error pages</strong><br />
			For error statuses (such as 404, 403, 405, 413, 500) it looks for a matching
			custom error page in the configuration. If found and readable, it uses that file
			as the response body, otherwise it generates a simple HTML error message.
		</li>
	</ol>

	<p>
		In short, the <code>Server</code> class takes a parsed HTTP request, finds the right
		route, enforces method and body-size constraints, maps URIs to the filesystem for
		default routes, performs basic GET/POST/DELETE operations on files and directories,
		and returns a <code>ServerResponse</code> with the appropriate status code,
		content type, and body (using configured error pages when available).
	</p>
</body>
</html>
